// Author: Gino Luciano Rojo
#include <bits/stdc++.h>
using namespace std;
static vector<double> mv(const vector<double>&x,int w){vector<double>y;double s=0;deque<double>q;for(double v:x){q.push_back(v);s+=v;if((int)q.size()>w){s-=q.front();q.pop_front();}y.push_back(s/q.size());}return y;}
static vector<int> pk(const vector<double>&x,double thr,int refi=50){vector<int>r;int last=-refi;for(int i=1;i+1<(int)x.size();++i){if(i-last<refi)continue; if(x[i]>thr&&x[i]>=x[i-1]&&x[i]>x[i+1]){r.push_back(i);last=i;}}return r;}
int main(){ios::sync_with_stdio(false);cin.tie(nullptr);cout<<"ECG Gateway by Gino Luciano Rojo\n";vector<double>s;string path;cout<<"Enter file with samples (empty=synth): ";getline(cin,path);if(!path.empty()){ifstream f(path);string line;while(getline(f,line)){try{s.push_back(stod(line));}catch(...){}}}if(s.empty()){for(int i=0;i<4000;++i){double base=0.05*sin(2*M_PI*1.2*(i/200.0));double sp=(i%200==0)?1.0:0.0;s.push_back(base+sp);}cout<<"Synthetic generated.\n";}cout<<"MA window (7): ";string t;getline(cin,t);int w=t.empty()?7:stoi(t);auto filt=mv(s,w);double mx=*max_element(filt.begin(),filt.end());cout<<"Threshold ("<<0.6*mx<<"): ";getline(cin,t);double thr=t.empty()?0.6*mx:stod(t);auto p=pk(filt,thr,50);cout<<"peaks="<<p.size()<<"\n";if(p.size()>1){vector<int>rr;for(size_t i=0;i+1<p.size();++i)rr.push_back(p[i+1]-p[i]);double m=accumulate(rr.begin(),rr.end(),0.0)/rr.size();double fs=200.0;double bpm=60.0/(m/fs);cout<<"bpm="<<bpm<<"\n";}}
